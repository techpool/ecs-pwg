FROM $DOCKER_REPO/ubuntu:16.04

# Install essentials
RUN apt-get update && \
	apt-get install -y \
		curl \
		build-essential \
		ca-certificates \
		gcc \
		git \
		libpq-dev \
		make \
		python-pip \
		python2.7 \
		python2.7-dev \
		ssh

# Install nginx
RUN apt-get install -y nginx

# Configure nginx
RUN echo "\ndaemon off;" >> /etc/nginx/nginx.conf
RUN chown -R www-data:www-data /var/lib/nginx

# Install node
RUN curl -sL https://deb.nodesource.com/setup_8.x | bash - && \
	apt-get install -y nodejs

# Cleanup
RUN apt-get autoremove
RUN apt-get clean

# configure fd limits
RUN echo -e "#commands\nroot soft nofile 65536\nroot hard nofile 65536\n* soft nofile 65536\n* hard nofile 65536" >> /etc/security/limits.conf
RUN ulimit -n 65536
RUN sysctl -w fs.file-max=64000


# RUN echo -e "fs.file-max = 64000" >> /etc/sysctl.conf 
# RUN sysctl -p
# RUN echo -e "ulimit -n 65536\n" >> /etc/sysconfig/docker
# RUN sysctl -w fs.file-max=64000

# Environment variables
ENV SERVICE_PORT 8085

# Copying nginx config files
COPY config/service.nginx.conf /etc/nginx/servers/ecs-service
COPY config/container.nginx.conf /etc/nginx/nginx.conf

# Copying node application files
COPY package.json .
COPY package-lock.json .
COPY src src
COPY server.js .
COPY worker.js .
COPY test.js .

# Installing node dependencies
RUN npm install
EXPOSE 80

# Starting nginx and node server
COPY start.sh .
CMD ["bash", "start.sh"]
